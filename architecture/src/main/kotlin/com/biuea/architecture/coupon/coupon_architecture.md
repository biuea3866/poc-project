# 선착순 이벤트 쿠폰 시스템
## 상황
특정 시간에 10만 명이 동시 접속, 1,000장의 쿠폰을 선착순으로 발급

## 요구 사항
동시성을 제어하고, 중복없이 1,000장의 쿠폰을 유저에게 발급

## 설계
### 고려 사항
1. 10만명이 동시에 페이지에 접근했을 때 발생하는 조회 api 해결 필요
   * 어느 페이지에서 발급을 시킬 것인지
   * 실제 제품 홈 페이지에서 쿠폰을 발급시킬 것인가?
     * 상품, 광고 등 도메인 서비스에 트래픽이 발생할 수 있음.
   * 이벤트 페이지로 이동시켜서 발급시킬 것인가?
     * 정적인 이미지만 있는 페이지이기 때문에 도메인 서비스에서의 데이터가 필요없음
     * 2번의 쓰기성 쿠폰 발급만 해결하면 됨.
   * 하지만 쿠폰 발급 페이지를 이동하기 위해선 결국 제품의 홈 페이지에서 이벤트 페이지로 넘어가야 함
     * 홈 페이지(트래픽 발생) -> 정적 이벤트 페이지
2. 쿠폰 발급을 동시에 신청했을 때 1000번째 유저까지만 발급 문제
   * 10만명을 동시에 api를 호출시키게 한다면, 특정 요청부터 밀리면서 타임아웃이 발생할 수 있고, 서버의 스레드, DB 커넥션 풀 등에서 문제가 발생할 수 있다.
   * api 형태로 단순 분산락으로 모든 요청을 대기시키는 방식
     * 동시에 모든 요청이 들어오므로 순차적으로 처리한다한들 결국 남은 요청들은 타임아웃 문제 발생
     
### 설계
#### 카프카, 웹소켓, redis 

![스크린샷 2025-12-18 01.01.19.png](%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202025-12-18%2001.01.19.png)

1. 클라이언트는 쿠폰 서버로 발급 요청을 수행한다.
   * 단, 발급 요청 시 분산 락으로 1000번째 까지의 순번은 제어해야한다.
   * 분산 락이 없다면, 동시에 n명의 클라이언트가 똑같은 순번을 발급받을 수 있기 때문이다.
   * 단순 메시지만 발행하는 로직이기 때문에 n번째가 증가할수록 딜레이가 생기더라도 감안이 된다.
2. 쿠폰 서버는 카프카로 메시지를 발행하고, 클라이언트에게 몇번째 순번인지 응답한다.
3. 클라이언트는 소켓 서버와 연결되고, 발급 여부를 실시간으로 알 수 있다.
4. 컨슈머 애플리케이션은 2번에서 전달받은 메시지를 처리하고, redis로 소켓 서버와 연결하여 처리 결과를 응답한다.

> 우려 포인트
* 대기열을 구성하기 위해 많은 인프라가 사용되기 때문에 어느 하나가 장애가 발생할 경우 처리를 어떻게 할 것인지
  * 카프카 장애
  * 소켓 서버 장애
  * 레디스 장애

#### Redis