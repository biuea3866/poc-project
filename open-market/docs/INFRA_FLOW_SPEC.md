# 🏗️ 인프라 플로우 스펙 (INFRA_FLOW_SPEC.md)

> **담당**: LLM Agent
> **범위**: 배포 환경, 모니터링, 부하테스트, CI/CD
> **아키텍처**: 모놀리식 + 멀티 인스턴스 (MSA 전환 대비)

---

## 1. 인프라 역할 정의

### 1.1 담당 영역
- 로컬 개발 환경 구성 (Docker Compose)
- CI/CD 파이프라인 구축
- 모니터링 시스템 구축 (Pinpoint)
- 부하/성능 테스트 (k6)
- 인프라 코드 관리

### 1.2 담당하지 않는 영역
- 애플리케이션 코드 (백엔드/프론트엔드 담당)
- 비즈니스 로직 (백엔드 담당)
- UI/UX (프론트엔드 담당)

---

## 2. 아키텍처 개요

### 2.1 현재 아키텍처: 모놀리식 멀티 인스턴스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Production Environment                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                        Load Balancer (Nginx)                        ││
│  └───────────────────────────────┬─────────────────────────────────────┘│
│                                  │                                       │
│          ┌───────────────────────┼───────────────────────┐              │
│          ▼                       ▼                       ▼              │
│  ┌───────────────┐       ┌───────────────┐       ┌───────────────┐     │
│  │  Backend #1   │       │  Backend #2   │       │  Backend #3   │     │
│  │  (Spring Boot)│       │  (Spring Boot)│       │  (Spring Boot)│     │
│  │  + Pinpoint   │       │  + Pinpoint   │       │  + Pinpoint   │     │
│  │    Agent      │       │    Agent      │       │    Agent      │     │
│  └───────┬───────┘       └───────┬───────┘       └───────┬───────┘     │
│          │                       │                       │              │
│          └───────────────────────┼───────────────────────┘              │
│                                  │                                       │
│  ┌───────────────────────────────┼───────────────────────────────────┐  │
│  │                     Shared Infrastructure                          │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │  │
│  │  │  MySQL  │  │  Redis  │  │  Kafka  │  │Elastic  │  │ Pinpoint│ │  │
│  │  │ Primary │  │ Cluster │  │ Cluster │  │ Search  │  │Collector│ │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                     Frontend (Static Hosting)                      │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │                      CDN / S3 + CloudFront                   │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 환경 구분

| 환경 | 용도 | 인스턴스 수 |
|------|------|------------|
| **Local** | 개발자 로컬 개발 | 1 (Docker Compose) |
| **Dev** | 개발 통합 테스트 | 1 |
| **Staging** | QA / 프로덕션 미러링 | 2 |
| **Production** | 실 서비스 | 3+ (오토스케일링) |

---

## 3. 로컬 개발 환경

### 3.1 Docker Compose 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                  Local Development (Docker Compose)              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  MySQL   │  │  Redis   │  │  Kafka   │  │ Elastic  │        │
│  │  :3306   │  │  :6379   │  │  :9092   │  │  :9200   │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │Zookeeper │  │ Kafka-UI │  │ Pinpoint │  │ Pinpoint │        │
│  │  :2181   │  │  :8090   │  │Collector │  │   Web    │        │
│  └──────────┘  └──────────┘  │  :9994   │  │  :8079   │        │
│                              └──────────┘  └──────────┘        │
│  ┌──────────┐  ┌──────────┐                                    │
│  │ PG Mock  │  │ Channel  │                                    │
│  │  :8081   │  │  Mock    │                                    │
│  └──────────┘  │  :8082   │                                    │
│                └──────────┘                                    │
│                                                                  │
│  호스트 머신:                                                    │
│  ┌──────────┐  ┌──────────┐                                    │
│  │ Backend  │  │ Frontend │                                    │
│  │  :8080   │  │  :3000   │                                    │
│  └──────────┘  └──────────┘                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 서비스별 역할

| 서비스 | 포트 | 용도 |
|--------|------|------|
| MySQL | 3306 | 메인 데이터베이스 |
| Redis | 6379 | 캐시, 세션, 분산락 |
| Kafka | 9092 | 메시지 큐 |
| Zookeeper | 2181 | Kafka 코디네이터 |
| Kafka-UI | 8090 | Kafka 관리 UI |
| Elasticsearch | 9200 | 검색 엔진 |
| Pinpoint Collector | 9994 | APM 데이터 수집 |
| Pinpoint Web | 8079 | APM 대시보드 |
| PG Mock | 8081 | PG사 Mock 서버 |
| Channel Mock | 8082 | 외부 채널 Mock 서버 |

### 3.3 개발 환경 실행 플로우

```
[개발자 환경 시작]
     │
     ▼
1. Docker Compose 실행
   $ docker-compose up -d
     │
     ▼
2. 인프라 서비스 Health Check
   - MySQL 연결 확인
   - Redis 연결 확인
   - Kafka 브로커 확인
     │
     ▼
3. 백엔드 애플리케이션 실행
   $ ./gradlew bootRun
   - Pinpoint Agent 연동
   - Profile: local
     │
     ▼
4. 프론트엔드 개발 서버 실행
   $ npm run dev
     │
     ▼
5. 개발 시작
   - Backend: http://localhost:8080
   - Frontend: http://localhost:3000
   - Pinpoint: http://localhost:8079
   - Kafka-UI: http://localhost:8090
```

---

## 4. 모니터링 시스템 (Pinpoint)

### 4.1 Pinpoint 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                      Pinpoint Monitoring                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Application Servers                       ││
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        ││
│  │  │  Backend #1  │ │  Backend #2  │ │  Backend #3  │        ││
│  │  │  ┌────────┐  │ │  ┌────────┐  │ │  ┌────────┐  │        ││
│  │  │  │Pinpoint│  │ │  │Pinpoint│  │ │  │Pinpoint│  │        ││
│  │  │  │ Agent  │  │ │  │ Agent  │  │ │  │ Agent  │  │        ││
│  │  │  └───┬────┘  │ │  └───┬────┘  │ │  └───┬────┘  │        ││
│  │  └──────┼───────┘ └──────┼───────┘ └──────┼───────┘        ││
│  └─────────┼────────────────┼────────────────┼────────────────┘│
│            │                │                │                  │
│            └────────────────┼────────────────┘                  │
│                             │                                    │
│                             ▼                                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                   Pinpoint Collector                         ││
│  │  - 에이전트 데이터 수집                                       ││
│  │  - 트레이스 데이터 처리                                       ││
│  │  - HBase 저장                                                ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                       HBase                                  ││
│  │  - 트레이스 데이터 저장                                       ││
│  │  - 통계 데이터 저장                                          ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Pinpoint Web                              ││
│  │  - 대시보드 UI                                               ││
│  │  - 서버맵 시각화                                             ││
│  │  - 트레이스 조회                                             ││
│  │  - 알람 설정                                                 ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Pinpoint 모니터링 항목

```
[Server Map]
- 애플리케이션 간 호출 관계 시각화
- 호출량, 응답시간, 에러율 표시
- 병목 지점 파악

[Call Stack]
- 개별 트랜잭션 상세 추적
- 메서드 레벨 실행 시간
- SQL 쿼리 분석
- 외부 API 호출 추적

[Inspector]
- JVM 힙 메모리 사용량
- CPU 사용률
- 활성 스레드 수
- GC 통계

[Alarm]
- 응답시간 임계치 초과 시 알림
- 에러율 임계치 초과 시 알림
- 힙 메모리 임계치 초과 시 알림
```

### 4.3 모니터링 플로우

```
[요청 처리 모니터링]
     │
     ├── 사용자 요청 → Backend 진입
     │        │
     │        ├── Pinpoint Agent가 트레이스 시작
     │        │
     │        ├── Controller → Service → Repository
     │        │   (각 레이어 실행 시간 기록)
     │        │
     │        ├── 외부 호출 (Redis, DB, Kafka, 외부 API)
     │        │   (외부 호출 시간 기록)
     │        │
     │        └── 응답 반환
     │             │
     │             └── 트레이스 완료 → Collector 전송
     │
     └── Pinpoint Web에서 조회
              │
              ├── Server Map: 전체 흐름 확인
              ├── Call Stack: 상세 분석
              └── Inspector: 리소스 사용량 확인
```

### 4.4 핵심 모니터링 대상

```
[API 성능]
- 상품 목록 조회: 평균 < 100ms, p99 < 200ms
- 상품 상세 조회: 평균 < 50ms, p99 < 100ms
- 주문 생성: 평균 < 300ms, p99 < 500ms
- 결제 처리: 평균 < 1000ms, p99 < 2000ms

[데이터베이스]
- 쿼리 실행 시간
- 커넥션 풀 사용률
- 슬로우 쿼리 감지

[외부 연동]
- PG사 API 응답 시간
- 외부 채널 API 응답 시간
- 타임아웃 발생 빈도
```

---

## 5. 부하/성능 테스트 (k6)

### 5.1 k6 테스트 전략

```
┌─────────────────────────────────────────────────────────────────┐
│                       k6 테스트 전략                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [테스트 유형]                                                   │
│                                                                  │
│  1. Smoke Test (연기 테스트)                                     │
│     - VU: 1~2명                                                  │
│     - 시간: 1분                                                  │
│     - 목적: 기본 동작 확인                                       │
│                                                                  │
│  2. Load Test (부하 테스트)                                      │
│     - VU: 점진적 증가 (10 → 50 → 100)                           │
│     - 시간: 10분                                                 │
│     - 목적: 정상 부하에서의 성능 확인                            │
│                                                                  │
│  3. Stress Test (스트레스 테스트)                                │
│     - VU: 한계까지 증가 (100 → 200 → 500 → ...)                 │
│     - 시간: 20분                                                 │
│     - 목적: 시스템 한계점 파악                                   │
│                                                                  │
│  4. Spike Test (스파이크 테스트)                                 │
│     - VU: 갑자기 급증 (10 → 500 → 10)                           │
│     - 시간: 5분                                                  │
│     - 목적: 급격한 트래픽 대응 능력 확인                         │
│                                                                  │
│  5. Soak Test (내구성 테스트)                                    │
│     - VU: 일정 수준 유지 (100명)                                 │
│     - 시간: 2시간+                                               │
│     - 목적: 장시간 운영 시 메모리 누수 등 확인                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 테스트 시나리오

```
[주요 플로우 테스트 시나리오]

Scenario 1: 상품 탐색 플로우
┌─────────────────────────────────────────┐
│  1. 메인 페이지 접속                     │
│  2. 카테고리 선택                        │
│  3. 상품 목록 조회 (필터, 정렬)          │
│  4. 상품 상세 조회                       │
│  5. 5초 대기 (사용자 읽기 시간)          │
│  6. 반복                                 │
└─────────────────────────────────────────┘

Scenario 2: 구매 플로우
┌─────────────────────────────────────────┐
│  1. 로그인                               │
│  2. 상품 상세 조회                       │
│  3. 장바구니 담기                        │
│  4. 장바구니 조회                        │
│  5. 주문 생성                            │
│  6. 결제 (Mock)                          │
└─────────────────────────────────────────┘

Scenario 3: 검색 플로우
┌─────────────────────────────────────────┐
│  1. 검색어 입력 (자동완성)               │
│  2. 검색 결과 조회                       │
│  3. 필터 적용                            │
│  4. 정렬 변경                            │
│  5. 페이지네이션                         │
└─────────────────────────────────────────┘

Scenario 4: 동시 주문 (재고 동시성)
┌─────────────────────────────────────────┐
│  1. 동일 상품에 100명 동시 접근          │
│  2. 동시 장바구니 담기                   │
│  3. 동시 주문 생성                       │
│  4. 재고 정합성 검증                     │
└─────────────────────────────────────────┘
```

### 5.3 성능 목표 (SLO)

```
┌─────────────────────────────────────────────────────────────────┐
│                        성능 목표 (SLO)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [응답 시간]                                                     │
│  ┌────────────────────────┬─────────┬─────────┬─────────┐      │
│  │ API                    │ 평균    │ p95     │ p99     │      │
│  ├────────────────────────┼─────────┼─────────┼─────────┤      │
│  │ 메인 페이지            │ < 100ms │ < 200ms │ < 500ms │      │
│  │ 상품 목록              │ < 100ms │ < 200ms │ < 500ms │      │
│  │ 상품 상세              │ < 50ms  │ < 100ms │ < 200ms │      │
│  │ 검색                   │ < 100ms │ < 200ms │ < 300ms │      │
│  │ 장바구니 담기          │ < 100ms │ < 200ms │ < 300ms │      │
│  │ 주문 생성              │ < 300ms │ < 500ms │ < 1000ms│      │
│  │ 결제 처리              │ < 1000ms│ < 2000ms│ < 3000ms│      │
│  └────────────────────────┴─────────┴─────────┴─────────┘      │
│                                                                  │
│  [처리량]                                                        │
│  - 동시 접속자: 1,000명                                          │
│  - 초당 요청: 500 RPS                                            │
│  - 일 주문량: 100,000건                                          │
│                                                                  │
│  [에러율]                                                        │
│  - 전체 에러율: < 0.1%                                           │
│  - 결제 에러율: < 0.01%                                          │
│                                                                  │
│  [가용성]                                                        │
│  - 월간 가용성: 99.9% (다운타임 < 43분/월)                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4 k6 테스트 실행 플로우

```
[부하 테스트 실행]
     │
     ▼
1. 테스트 환경 준비
   - Staging 환경 또는 별도 테스트 환경
   - 테스트 데이터 세팅 (상품, 사용자)
     │
     ▼
2. k6 테스트 실행
   $ k6 run --out influxdb=http://localhost:8086/k6 load-test.js
     │
     ▼
3. 실시간 모니터링
   - k6 Cloud 또는 Grafana 대시보드
   - Pinpoint 병행 모니터링
     │
     ▼
4. 결과 분석
   - 응답 시간 분포
   - 에러율
   - 처리량
     │
     ▼
5. 리포트 생성
   - 병목 지점 식별
   - 개선 사항 도출
```

---

## 6. CI/CD 파이프라인

### 6.1 CI/CD 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                       CI/CD Pipeline                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [개발자]                                                        │
│     │                                                            │
│     │  git push                                                  │
│     ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  GitHub Actions Trigger                                      ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  CI Stage                                                    ││
│  │  1. 코드 체크아웃                                            ││
│  │  2. 의존성 설치                                              ││
│  │  3. 린트 검사                                                ││
│  │  4. 유닛 테스트                                              ││
│  │  5. 통합 테스트 (Testcontainers)                             ││
│  │  6. 빌드                                                     ││
│  │  7. Docker 이미지 빌드                                       ││
│  │  8. 이미지 푸시 (Container Registry)                         ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  CD Stage (develop 브랜치)                                   ││
│  │  1. Dev 환경 배포                                            ││
│  │  2. Smoke 테스트                                             ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  CD Stage (main 브랜치 - 수동 승인)                          ││
│  │  1. Staging 환경 배포                                        ││
│  │  2. 통합 테스트                                              ││
│  │  3. 부하 테스트 (k6)                                         ││
│  │  4. 승인 대기                                                ││
│  │  5. Production 배포 (Rolling Update)                         ││
│  │  6. Health Check                                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 배포 전략

```
[Rolling Update]
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  Instance 1: v1.0 ──────────────────────────────────────        │
│  Instance 2: v1.0 ─────────────────────────                     │
│  Instance 3: v1.0 ──────────────                                │
│                    │           │           │                     │
│                    ▼           │           │                     │
│  Instance 1: v1.1 시작         │           │                     │
│              Health OK ────────▼           │                     │
│              트래픽 전환   Instance 2: v1.1│                     │
│                           Health OK ───────▼                     │
│                           트래픽 전환   Instance 3: v1.1         │
│                                         Health OK                │
│                                         트래픽 전환              │
│                                                                  │
│  완료: 모든 인스턴스 v1.1                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

[롤백 전략]
- 배포 후 에러율 급증 시 자동 롤백
- 수동 롤백 명령 지원
- 이전 버전 이미지 유지 (최근 5개)
```

---

## 7. 로깅/알림

### 7.1 로깅 전략

```
[로그 수집 플로우]
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌──────────────┐                                               │
│  │  Application │ → 로그 출력 (JSON 포맷)                       │
│  └──────┬───────┘                                               │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐                                               │
│  │  Filebeat    │ → 로그 파일 수집                              │
│  └──────┬───────┘                                               │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐                                               │
│  │ Elasticsearch│ → 로그 저장 / 인덱싱                          │
│  └──────┬───────┘                                               │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐                                               │
│  │   Kibana     │ → 로그 조회 / 대시보드                        │
│  └──────────────┘                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

[로그 레벨]
- ERROR: 에러 발생, 즉시 조치 필요
- WARN: 잠재적 문제, 모니터링 필요
- INFO: 주요 비즈니스 이벤트
- DEBUG: 개발/디버깅용 (운영 환경에서는 비활성화)
```

### 7.2 알림 전략

```
[알림 채널]
- Slack: 개발팀 채널
- Email: 온콜 담당자
- SMS: 긴급 장애 시

[알림 조건]
- 에러율 > 1% (5분 이상 지속)
- 응답시간 p99 > SLO (5분 이상 지속)
- 인스턴스 다운
- 디스크 사용량 > 80%
- 메모리 사용량 > 90%
- 결제 실패율 > 0.5%
```

---

## 8. MSA 전환 대비

### 8.1 현재 → MSA 전환 계획

```
[현재: 모놀리식]
┌─────────────────────────────────────────┐
│           Open Market Monolith          │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐      │
│  │User │ │Shop │ │Order│ │Pay  │ ...  │
│  └─────┘ └─────┘ └─────┘ └─────┘      │
└─────────────────────────────────────────┘

[MSA 전환 시]
┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
│ User  │ │ Shop  │ │ Order │ │Payment│
│Service│ │Service│ │Service│ │Service│
└───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘
    │         │         │         │
    └─────────┼─────────┼─────────┘
              │         │
        ┌─────┴─────────┴─────┐
        │    API Gateway      │
        │    (Kong/Envoy)     │
        └─────────────────────┘
```

### 8.2 MSA 전환 시 인프라 변경 사항

```
[추가 필요 인프라]
- API Gateway (Kong, Envoy, 등)
- Service Discovery (Consul, Eureka)
- 분산 트레이싱 (Pinpoint 유지 또는 Jaeger)
- Config Server (Spring Cloud Config)
- Circuit Breaker (Resilience4j)

[인프라 요청 시점]
- MSA 전환 결정 시 별도 요청
- 도메인별 분리 우선순위 논의 후 진행
```

---

## 9. 인프라 폴더 구조

```
infra/
├── docker/
│   ├── docker-compose.yml          # 로컬 개발 환경
│   ├── docker-compose.test.yml     # 테스트 환경
│   ├── pinpoint/                   # Pinpoint 설정
│   │   ├── collector/
│   │   └── web/
│   └── init/                       # 초기화 스크립트
│       ├── mysql/
│       └── elasticsearch/
│
├── k6/
│   ├── scenarios/
│   │   ├── smoke.js
│   │   ├── load.js
│   │   ├── stress.js
│   │   └── spike.js
│   ├── scripts/
│   │   ├── product-browsing.js
│   │   ├── purchase-flow.js
│   │   └── search-flow.js
│   └── thresholds.json
│
├── .github/
│   └── workflows/
│       ├── backend-ci.yml
│       ├── frontend-ci.yml
│       ├── deploy-dev.yml
│       ├── deploy-staging.yml
│       └── deploy-prod.yml
│
└── monitoring/
    ├── pinpoint/
    │   └── agent/                  # Agent 설정
    └── alerting/
        └── slack-webhook.yml
```
